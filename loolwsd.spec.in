%if "ndcodfapi" == "@BUNDLE_NAME@"
%define pkg_ver 1.0.0
%define pkg_conv_ver 1.0.0
%define pkg_conv_ver_re 1
%define pkg_merge_ver 1.0.0
%define pkg_merge_ver_re 2
%define pkg_re 2
%define pkg_oxool @BUNDLE_NAME@
%define pkg_merge ndcodfapi-plugin-odfreport
%define pkg_conv ndcodfapi-plugin-odfconvert
%define conf_bundle ndc
%else
%define pkg_ver @PACKAGE_VERSION@
%define pkg_conv_ver 2.0.1
%define pkg_conv_ver_re 10
%define pkg_merge_ver 2.0.1
%define pkg_merge_ver_re 21
%define pkg_re @LOOLWSD_VERSION_DIST@%{?dist}
%define pkg_oxool oxool-ossii
%define pkg_merge mergeodf
%define pkg_conv convertto
%define conf_bundle ossii
%endif

Summary:        OxOffice On-Line WebSocket Daemon
Name:           %pkg_oxool
Conflicts:	oxool
Version:        %pkg_ver
Release:        %pkg_re
License:        Commercial
Source0:        online_patch.tar.gz

# build tools
BuildRequires: autoconf
BuildRequires: automake
BuildRequires: findutils
BuildRequires: gcc-c++
#BuildRequires: git
BuildRequires: make
BuildRequires: yum
BuildRequires: libtool cppunit-devel

BuildRequires: libpng-devel
BuildRequires: openssl-devel
BuildRequires: libcap-devel
BuildRequires: nodejs
#BuildRequires: npm
BuildRequires: poco-devel >= 1.7.3
BuildRequires: oxoffice-core

Requires: oxofficedemo >= 6.2.0.1.0
Requires: expat keyutils-libs krb5-libs libattr libcap libcom_err libgcc libpng libselinux openssl-libs pcre xz-libs zlib
Requires: poco-crypto >= 1.7.3 poco-foundation >= 1.7.3 poco-json >= 1.7.3 poco-net >= 1.7.3 poco-netssl >= 1.7.3 poco-util >= 1.7.3 poco-xml >= 1.7.3
Requires: cronie sqlite

%if 0%{?name_suffix:1}
Provides:       loleaflet = 1.5.8, oxoolwsd
%else
Provides:       loleaflet = 1.5.8
%endif
Obsoletes:      loleaflet <= 1.5.8

Conflicts: oxool-asus oxool-openfind ndcodfapi

%description
oxool

%prep
%setup -q -n online_patch

%build
%if 1
./autogen.sh
%configure --enable-slient-rules \
	--disable-setcap \
	--disable-werror \
	--with-lokit-path=bundled/include \
	--with-lo-path=/opt/libreoffice \
	--with-logfile=/var/log/oxoolwsd.log \
	--disable-debug --enable-ssl \
	--with-max-documents=65535 --with-max-connections=65535
env BUILDING_FROM_RPMBUILD=yes %{__make} %{?_smp_mflags}

#git checkout -- loleaflet/node_modules/
#pushd loleaflet
#rm dist/bundle.js
npm install -g jake browserify
%{__make} %{?_smp_mflags}
%endif

%install
#cd online
rm -rf $RPM_BUILD_ROOT
env BUILDING_FROM_RPMBUILD=yes DESTDIR=$RPM_BUILD_ROOT make install
%__install -m 444 discovery.xml $RPM_BUILD_ROOT/%{_datadir}/oxoolwsd/loleaflet/dist/
%__install -m 444 etc/ca-chain.cert.pem $RPM_BUILD_ROOT/etc/oxoolwsd/ca-chain.cert.pem
%__install -m 444 etc/cert.pem $RPM_BUILD_ROOT/etc/oxoolwsd/cert.pem
%__install -m 444 etc/key.pem $RPM_BUILD_ROOT/etc/oxoolwsd/key.pem
#%__install -m 444 styles.xml $RPM_BUILD_ROOT/%{_datadir}/loolwsd/loleaflet/dist/
%__install -D -m 444 loolwsd.service %{buildroot}%{_unitdir}/oxool.service
#%__install -D -m 444 %{SOURCE1} %{buildroot}%{_unitdir}/oxool.service
%__cp loolwsd.xml $RPM_BUILD_ROOT/etc/oxoolwsd/oxoolwsd.xml
mkdir -p $RPM_BUILD_ROOT/var/cache/oxoolwsd

mkdir -p $RPM_BUILD_ROOT/var/log
touch $RPM_BUILD_ROOT/var/log/oxoolwsd.log

mkdir -p %{buildroot}/etc/cron.d
echo "#Remove old tiles once every 10 days at midnight" > %{buildroot}/etc/cron.d/oxoolwsd.cron
echo "0 0 */1 * * root find /var/cache/oxoolwsd -name \"*.png\" -a -atime +10 -exec rm {} \;" >> %{buildroot}/etc/cron.d/oxoolwsd.cron

%pre
getent group lool >/dev/null || groupadd -r lool
getent passwd lool >/dev/null || useradd -g lool -r lool -m

%post
setcap cap_fowner,cap_mknod,cap_sys_chroot=ep /usr/bin/oxoolforkit
#setcap cap_sys_admin=ep /usr/bin/loolmount
setcap CAP_NET_BIND_SERVICE=+eip /usr/bin/oxoolwsd

rm -rf %{_datarootdir}/oxoolwsd/systemplate
oxoolwsd-systemplate-setup %{_datarootdir}/oxoolwsd/systemplate /opt/libreoffice >/dev/null 2>&1

%systemd_post oxool.service

%preun
%systemd_preun oxool.service

%postun
%systemd_postun oxool.service

%files
%defattr(-,root,root)
/usr/bin/oxoolwsd
/usr/bin/oxoolwsd-systemplate-setup
/usr/bin/oxoolforkit
/usr/bin/oxoolconvert
/usr/bin/oxoolconfig
#%{_bindir}/loolforkit
#%{_bindir}/loolmap
#%{_bindir}/loolmount
#%{_bindir}/loolstress
#%{_bindir}/looltool
%{_bindir}/oxoolwsd
%{_bindir}/oxoolwsd-systemplate-setup
#%{_bindir}/oxoolgetuser
#%{_bindir}/prune_tokens.sh
%dir %attr(777, root, root) %{_datadir}/oxoolwsd
%{_datadir}/oxoolwsd/*
%dir %attr(777, root, root) /var/cache/oxoolwsd
%{_unitdir}/oxool.service
/etc/cron.d/oxoolwsd.cron
%config(noreplace) /etc/oxoolwsd/oxoolwsd.xml
#%config(noreplace) /etc/oxoolwsd/perm.xml
%config(noreplace) /etc/oxoolwsd/ca-chain.cert.pem
%config(noreplace) /etc/oxoolwsd/cert.pem
%config(noreplace) /etc/oxoolwsd/key.pem
%config /etc/oxoolwsd/oxoolkitconfig.xcu
/usr/share/doc/oxoolwsd/reference.md
%exclude /usr/share/man/man1/loolwsd.1.gz
%exclude /usr/share/man/man1/loolforkit.1.gz
%exclude /usr/share/man/man1/loolconvert.1.gz
%exclude /usr/share/man/man1/loolconfig.1.gz
%exclude /usr/share/man/man1/loolwsd-systemplate-setup.1.gz
%{_docdir}/oxoolwsd/README
%{_docdir}/oxoolwsd/README.vars
%{_docdir}/oxoolwsd/protocol.txt
#%{_docdir}/loolwsd/reference.txt
#%dir %attr(755, lool, lool) /usr/local/share/loolwsd
%exclude /etc/apache2/conf-available/loolwsd.conf
%exclude /etc/nginx/snippets/loolwsd.conf

%config(noreplace) %attr(664, lool, lool) /var/log/oxoolwsd.log

%changelog
