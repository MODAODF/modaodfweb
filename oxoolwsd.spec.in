# spec file for package loolwsd
#
# Copyright (c) 2015 Collabora
#
# This file is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

%define config_options --disable-debug --enable-ssl -with-max-documents=8192 --with-max-connections=8192
%define loroot /opt/oxoffice

Name:           @PACKAGE_NAME@
Version:        @PACKAGE_VERSION@
Release:        @LOOLWSD_VERSION_DIST@.@LOOLWSD_BRANCH@%{?dist}
Vendor:         %{vendor}
Summary:        OxOffice Online WebSocket Daemon for @LOOLWSD_BRANCH@
License:        MPL
Obsoletes:	oxoolwsd
Source0:        @PACKAGE_NAME@-%{version}-@LOOLWSD_BRANCH@.tar.gz
BuildRequires:  libcap-devel libpng-devel poco-devel >= 1.7.5
%if 0%{?fedora} || 0%{?rhel} >= 7
BuildRequires:  libpcap kernel-headers
%endif
Requires:       systemd
Requires(post): coreutils grep sed
%if 0%{?fedora} || 0%{?rhel} >= 7
# loolwsd dependencies
Requires:       expat keyutils-libs krb5-libs libattr libcap libcom_err libgcc libpng libselinux openssl-libs pcre xz-libs zlib
Requires:       poco-crypto >= 1.7.5 poco-foundation >= 1.7.5 poco-json >= 1.7.5 poco-net >= 1.7.5 poco-netssl >= 1.7.5 poco-util >= 1.7.5 poco-xml >= 1.7.5
# LibreOffice dependencies (unfortunately upstream LibreOffice RPM packages (from TDF) do not have real dependencies)
Requires:       atk avahi-libs bzip2-libs cairo cups-libs dbus-glib dbus-libs fontconfig freetype gdk-pixbuf2 glib2 graphite2 gtk2 harfbuzz libdrm libffi libICE libSM libuuid libX11 libXau libxcb libXcomposite libXcursor libXdamage libXext libXfixes libXi libXinerama libXrandr libXrender libxshmfence libXt libXxf86vm mesa-libEGL mesa-libgbm mesa-libGL mesa-libglapi pango pixman
%endif

%description

%prep
%setup -q -n %{name}-%{version}-@LOOLWSD_BRANCH@

%build
%configure \
	--enable-silent-rules \
	--with-lokit-path=bundled/include \
	--with-lo-path=%{loroot} \
	--disable-setcap \
%if 0%{?config_options:1}
	%{config_options}
%endif

make %{?_smp_mflags}

%check
#make check

%install
%make_install

%__install -D -m 444 oxoolwsd.service %{buildroot}%{_unitdir}/oxoolwsd.service

install -d -m 755 %{buildroot}/var/adm/fillup-templates
mkdir -p %{buildroot}/etc/cron.d
echo "#Remove old tiles once every 10 days at midnight" > %{buildroot}/etc/cron.d/%{name}.cron
echo "0 0 */1 * * root find /var/cache/%{name} -type f -a -atime +10 -exec rm {} \;" >> %{buildroot}/etc/cron.d/%{name}.cron
mkdir -p %{buildroot}/etc/pam.d
echo "auth       required     pam_unix.so" > %{buildroot}/etc/pam.d/%{name}
echo "account    required     pam_unix.so" >>  %{buildroot}/etc/pam.d/%{name}

%files
/usr/bin/oxoolwsd
/usr/bin/oxoolwsd-systemplate-setup
/usr/bin/oxoolforkit
/usr/bin/oxoolconvert
/usr/bin/oxoolconfig
/usr/share/fonts/SourceHan/*.ttc
%dir /usr/share/%{name}
/usr/share/%{name}/loleaflet
/usr/share/%{name}/discovery.xml
/usr/share/%{name}/favicon.ico
/usr/share/%{name}/extensions
/usr/share/doc/%{name}/README
/usr/share/doc/%{name}/README.vars
/usr/share/doc/%{name}/protocol.txt
/usr/share/doc/%{name}/reference.md
/usr/share/man/man1/oxoolwsd.1.gz
/usr/share/man/man1/oxoolforkit.1.gz
/usr/share/man/man1/oxoolconvert.1.gz
/usr/share/man/man1/oxoolconfig.1.gz
/usr/share/man/man1/oxoolwsd-systemplate-setup.1.gz
%{_unitdir}/oxoolwsd.service
%config(noreplace) /etc/sysconfig/oxoolwsd

%dir /etc/%{name}
%config(noreplace) /etc/cron.d/%{name}.cron
%config(noreplace) /etc/pam.d/%{name}
%config(noreplace) %attr(640, lool, root) /etc/%{name}/oxoolwsd.xml
%config /etc/fonts/conf.d/50-oxool.conf
%config /etc/%{name}/oxoolkitconfig.xcu
%config(noreplace) /etc/%{name}/*.pem
%config %attr(440, root, root) /etc/sudoers.d/lool

%doc README

%pre
getent group lool >/dev/null || groupadd -r lool
getent passwd lool >/dev/null || useradd -g lool -r lool

%post
setcap cap_fowner,cap_mknod,cap_sys_chroot=ep /usr/bin/oxoolforkit
fc-cache -f

mkdir -p /var/cache/%{name} && chown lool:lool /var/cache/%{name}
rm -rf /var/cache/%{name}/*

touch /var/log/oxoolwsd.log && chown lool:lool /var/log/oxoolwsd.log

# Figure out where LO is installed, let's hope it is not a mount point
# Create a directory for oxloolwsd on the same file system
loroot=%{loroot}
loolparent=`cd ${loroot} && cd .. && /bin/pwd`

rm -rf ${loolparent}/%{name}
mkdir -p ${loolparent}/%{name}/child-roots
chown lool:lool ${loolparent}/%{name}
chown lool:lool ${loolparent}/%{name}/child-roots

fc-cache ${loroot}/share/fonts/truetype
su lool -c "oxoolwsd-systemplate-setup ${loolparent}/%{name}/systemplate ${loroot} "%{_datadir}/%{name}/extensions" >/dev/null 2>&1"

%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_post oxoolwsd.service
%endif


%preun
%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_preun oxoolwsd.service
%endif

%postun
arg="$1"
fc-cache -f
%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_postun oxoolwsd.service
%endif

# Real uninstall
# 如果是1，表示是 upgrade，不需要刪除檔案
if [ $arg = 0 ] ; then
    # log file
    rm -f /var/log/oxoolwsd.log
    # cache dir
    rm -fr /var/cache/%{name}
    # systemplate & child root
    loroot=%{loroot}
    loolparent=`cd ${loroot} && cd .. && /bin/pwd`
    rm -rf ${loolparent}/%{name}
fi
 

%changelog
