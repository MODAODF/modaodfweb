# spec file for package loolwsd
#
# Copyright (c) 2015 Collabora
#
# This file is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

%define config_options --disable-werror --with-logfile=/var/log/@PACKAGE_NAME@.log --disable-debug --enable-ssl -with-max-documents=8192 --with-max-connections=8192
%define loroot /opt/oxoffice

%if 0%{?name_suffix:1}
Name:           @PACKAGE_NAME@%{name_suffix}
%else
Name:           @PACKAGE_NAME@
%endif
Version:        @PACKAGE_VERSION@
Release:        1%{?dist}
Vendor:         %{vendor}
Summary:        OxOffice Online WebSocket Daemon
License:        MPL
Source0:        @PACKAGE_NAME@-%{version}.tar.gz
BuildRequires:  libcap-devel libpng-devel poco-devel >= 1.7.5
%if 0%{?fedora} || 0%{?rhel} >= 7
BuildRequires:  libpcap kernel-headers
%endif
Requires:       systemd
Requires(post): coreutils grep sed
%if 0%{?fedora} || 0%{?rhel} >= 7
# loolwsd dependencies
Requires:       expat keyutils-libs krb5-libs libattr libcap libcom_err libgcc libpng libselinux openssl-libs pcre xz-libs zlib
Requires:       poco-crypto >= 1.7.5 poco-foundation >= 1.7.5 poco-json >= 1.7.5 poco-net >= 1.7.5 poco-netssl >= 1.7.5 poco-util >= 1.7.5 poco-xml >= 1.7.5
# LibreOffice dependencies (unfortunately upstream LibreOffice RPM packages (from TDF) do not have real dependencies)
Requires:       atk avahi-glib avahi-libs bzip2-libs cairo cups-libs dbus-glib dbus-libs fontconfig freetype GConf2 gdk-pixbuf2 glib2 gnome-vfs2 graphite2 gstreamer gstreamer-plugins-base gtk2 harfbuzz libdrm libffi libICE libSM libuuid libX11 libXau libxcb libXcomposite libXcursor libXdamage libXext libXfixes libXi libXinerama libXrandr libXrender libxshmfence libXt libXxf86vm mesa-libEGL mesa-libgbm mesa-libGL mesa-libglapi pango pixman
%endif

%description

%prep
%setup -n @PACKAGE_NAME@-@PACKAGE_VERSION@

%build
%configure \
	--enable-silent-rules \
	--with-lokit-path=bundled/include \
	--with-lo-path=%{loroot} \
	--disable-setcap \
%if 0%{?config_options:1}
	%{config_options}
%endif

make %{?_smp_mflags}

%check
#make check

%install
make install DESTDIR=%{buildroot}
%__install -D -m 444 %{name}.service %{buildroot}%{_unitdir}/%{name}.service
install -d -m 755 %{buildroot}/var/adm/fillup-templates
%if 0%{?fedora} || 0%{?rhel} >= 7
install -D -m 644 sysconfig.oxoolwsd %{buildroot}/etc/sysconfig/%{name}
%endif
mkdir -p %{buildroot}/etc/cron.d
echo "#Remove old tiles once every 10 days at midnight" > %{buildroot}/etc/cron.d/%{name}.cron
echo "0 0 */1 * * root find /var/cache/%{name} -type f -a -atime +10 -exec rm {} \;" >> %{buildroot}/etc/cron.d/%{name}.cron
mkdir -p %{buildroot}/etc/pam.d
echo "auth       required     pam_unix.so" > %{buildroot}/etc/pam.d/%{name}
echo "account    required     pam_unix.so" >>  %{buildroot}/etc/pam.d/%{name}

%files
/usr/bin/oxoolwsd
/usr/bin/%{name}-systemplate-setup
/usr/bin/oxoolforkit
/usr/bin/oxoolconvert
/usr/bin/oxoolconfig
%dir /usr/share/%{name}
/usr/share/%{name}/loleaflet
/usr/share/%{name}/discovery.xml
/usr/share/%{name}/favicon.ico
/usr/share/doc/%{name}/README
/usr/share/doc/%{name}/README.vars
/usr/share/doc/%{name}/protocol.txt
/usr/share/doc/%{name}/reference.md
/usr/share/man/man1/oxoolwsd.1.gz
/usr/share/man/man1/oxoolforkit.1.gz
/usr/share/man/man1/oxoolconvert.1.gz
/usr/share/man/man1/oxoolconfig.1.gz
/usr/share/man/man1/%{name}-systemplate-setup.1.gz
%{_unitdir}/%{name}.service
%if 0%{?fedora} || 0%{?rhel} >= 7
%config(noreplace) /etc/sysconfig/%{name}
%endif

%dir /etc/%{name}
%config(noreplace) /etc/cron.d/%{name}.cron
%config(noreplace) /etc/pam.d/oxoolwsd
%config(noreplace) %attr(640, lool, root) /etc/%{name}/%{name}.xml
%config /etc/%{name}/oxoolkitconfig.xcu
%config(noreplace) /etc/%{name}/*.pem

%doc README

%pre

getent group lool >/dev/null || groupadd -r lool
getent passwd lool >/dev/null || useradd -g lool -r lool

%post
setcap cap_fowner,cap_mknod,cap_sys_chroot=ep /usr/bin/oxoolforkit

mkdir -p /var/cache/%{name} && chown lool:lool /var/cache/%{name}
rm -rf /var/cache/%{name}/*

touch /var/log/%{name}.log && chown lool:lool /var/log/%{name}.log

# Figure out where LO is installed, let's hope it is not a mount point
# Create a directory for oxloolwsd on the same file system
loroot=%{loroot}
loolparent=`cd ${loroot} && cd .. && /bin/pwd`

rm -rf ${loolparent}/%{name}
mkdir -p ${loolparent}/%{name}/child-roots
chown lool:lool ${loolparent}/%{name}
chown lool:lool ${loolparent}/%{name}/child-roots

fc-cache ${loroot}/share/fonts/truetype
su lool -c "%{name}-systemplate-setup ${loolparent}/%{name}/systemplate ${loroot} >/dev/null 2>&1"

%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_post %{name}.service
%endif


%preun
%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_preun %{name}.service
%endif

%postun
%if 0%{?fedora} || 0%{?rhel} >= 7
%systemd_postun %{name}.service
%endif
rm -fr /var/cache/%{name}

%changelog
